name: Conventional Commits on PR

on: 
  pull_request: 
    types: [opened, synchronize]

permissions: 
  pull-requests: write
  contents: read 
  issues: write

jobs:
  check-commits:
      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v4
    
      - name: Check for Conventional Commits
        id: conventional
        uses: webiny/action-conventional-commits@v1.3.1
        continue-on-error: true
    
      - name: Close PR on Failure
        if: steps.conventional.outcome == 'failure'
        run: 'gh pr close ${{ github.event.pull_request.number }} --comment "Closing: commits are not Conventional Commits compliant."'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
      - name: Email on failure (SendGrid API)
        if: steps.conventional.outcome == 'failure'
        uses: sendgrid/action-sendgrid@v1
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        with:
          mail: |
            {
              "personalizations": [
                {
                  "to": [{"email": "${{ secrets.NOTIFY_EMAIL_TO }}"}],
                  "subject": "Failure: Conventional Commits Required"
                }
              ],
              "from": {"email": "taylorkayli123@gmail.com"},
              "content": [
                {
                  "type": "text/plain",
                  "value": "Failure to provide conventional commits. PR closed. ${{ github.event.pull_request.html_url }}"
                }
              ]
            }
          
      - name: Debug FROM (safe)
        if: always()
        run: |
          FROM="${{ secrets.NOTIFY_EMAIL_FROM }}"
            echo "FROM length: ${#FROM}"
            if [ "$FROM" = "taylorkayli123@gmail.com" ]; then
              echo "FROM matches verified Gmail ✅"
            else
              echo "FROM does NOT match verified Gmail ❌"
            fi
                  
